{"version":3,"sources":["../../src/common/fetch.helper.js"],"names":["Logger","encode","result","name","value","mode","File","Date","toJSON","JSON","parse","Array","isArray","forEach","val","index","Object","keys","key","encodeURIComponent","String","toQueryString","data","outcome","map","join","toFormData","FormData","append","Request","method","url","options","route","query","headers","body","more","entries","param","replace","RegExp","queryString","Accept","toString","call","stringify","request","global","events","EventEmitter","ResponseHandler","response","successModifier","payload","failureModifier","error","content","contentType","get","Promise","resolve","startsWith","json","text","then","ok","code","message","extra","status","FetchError","from","emit","catch","ErrorValueHandler","_error","ErrorHandler","reject","process","env","NODE_ENV","FetchHelper","module","exports","on","debug"],"mappings":"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","sourcesContent":["import { EventEmitter } from './events';\n\nimport { FetchError } from './error';\n\nimport { createLogger } from './logger';\n\nconst Logger = createLogger('FetchHelper');\n\n/**\n * Query String and Form Data\n */\n\nexport function encode(result, name, value, mode = 'querystring') {\n  if (typeof value === 'object' && value) {\n    if (value instanceof File) {\n      if (mode === 'formdata') {\n        result[name] = value;\n      } else if (mode === 'querystring') {\n        // result[name] = new FileReader().readAsDataURL(value);\n      }\n    } else if (value instanceof Date) {\n      result[name] = value.toJSON();\n    } else if (typeof value.toJSON === 'function') {\n      encode(result, name, JSON.parse(value.toJSON()), mode);\n    } else if (Array.isArray(value)) {\n      value.forEach((val, index) => encode(result, `${name}[${index}]`, val, mode));\n    } else {\n      Object.keys(value).forEach((key) => encode(result, `${name}[${encodeURIComponent(key)}]`, value[key], mode));\n    }\n  } else {\n    result[name] = encodeURIComponent(String(value));\n  }\n}\n\nexport function toQueryString(data) {\n  const result = {};\n  Object.keys(data).forEach((key) => encode(result, encodeURIComponent(key), data[key], 'querystring'));\n  const outcome = Object.keys(result)\n    .map((key) => `${key}=${result[key]}`)\n    .join('&');\n  return outcome;\n}\n\nexport function toFormData(data) {\n  const result = {};\n  Object.keys(data).forEach((key) => encode(result, encodeURIComponent(key), data[key], 'formdata'));\n  const outcome = new FormData();\n  Object.keys(result).forEach((key) => outcome.append(key, result[key]));\n  return outcome;\n}\n\nexport function Request(method, url, options = {}) {\n  let {\n    route, query, headers, body, ...more\n  } = options;\n\n  route = route || {};\n  query = query || {};\n  headers = headers || {};\n\n  Object.entries(route).forEach(([param, value]) => {\n    url = url.replace(new RegExp(`:${param}`), encodeURIComponent(value));\n  });\n\n  const queryString = toQueryString(query);\n\n  url += queryString ? `?${queryString}` : '';\n\n  headers.Accept = 'application/json';\n\n  if (body && typeof body === 'object') {\n    if (toString.call(body) === '[object Object]' || toString.call(body) === '[object Array]') {\n      headers['Content-Type'] = 'application/json';\n      body = JSON.stringify(body);\n    }\n    // if (body instanceof FormData) {\n    //   headers['Content-Type'] = 'multipart/form-data';\n    // }\n\n    // if (body instanceof URLSearchParams) {\n    //   headers['Content-Type'] = 'application/x-www-form-urlencoded;charset=UTF-8';\n    // }\n  }\n\n  const request = new global.Request(url, {\n    method,\n    headers,\n    body,\n    ...more,\n  });\n\n  return request;\n}\n\n/**\n * Response Listeners\n */\n\nexport const events = new EventEmitter();\n\n/**\n * Response Handler\n * Converts JSON to Object and throws error for non-success statuses\n */\n\nexport function ResponseHandler(\n  response,\n  successModifier = (payload, response) => payload,\n  failureModifier = (error, response) => error,\n) {\n  let content;\n\n  const contentType = response.headers.get('Content-Type', '');\n\n  if (contentType === null) {\n    content = Promise.resolve(null);\n  } else if (contentType.startsWith('application/json')) {\n    content = response.json();\n  } else {\n    content = response.text().then((text) => ({ text }));\n  }\n\n  return content\n    .then((payload) => {\n      payload = payload || {};\n\n      let error = null;\n\n      if (payload.error && typeof payload.error === 'object') {\n        error = payload.error;\n      }\n\n      if (error || !response.ok) {\n        error = error || payload;\n\n        let { code, message, ...extra } = error;\n\n        if (typeof payload.error === 'string') {\n          message = message || payload.error;\n        }\n\n        if (response.status === 400) {\n          code = code || 'Invalid';\n          message = message || 'Invalid request';\n        } else if (response.status === 401) {\n          code = code || 'Unauthenticated';\n          message = message || 'Unauthenticated';\n        } else if (response.status === 403) {\n          code = code || 'Unauthorized';\n          message = message || 'Unauthorized';\n        } else if (response.status === 404) {\n          code = code || 'NotFound';\n          message = message || 'Not found';\n        } else if (response.status >= 500) {\n          code = code || 'Server';\n          message = message || 'Server error';\n        } else {\n          code = code || 'Unknown';\n          message = message || 'Unknown error';\n        }\n\n        error = FetchError.from(error, { code, message, ...extra });\n\n        error = failureModifier(error, response);\n\n        throw error;\n      }\n\n      payload = successModifier(payload, response);\n\n      events.emit('success', payload, response);\n\n      return payload;\n    })\n    .catch((error) => {\n      events.emit('failure', error, response);\n\n      throw FetchError.from(error);\n    });\n}\n\nexport function ErrorValueHandler(_error, failureModifier = (error, response) => error) {\n  let { code } = _error;\n  let message = _error.message || _error.error;\n\n  code = code || 'Unknown';\n  message = message || 'Unknown error';\n\n  let error = FetchError.from(_error, { code, message });\n\n  const response = {};\n\n  error = failureModifier(error, response);\n\n  events.emit('failure', error, response);\n\n  return error;\n}\n\nexport function ErrorHandler(_error, failureModifier) {\n  return Promise.reject(ErrorValueHandler(_error, failureModifier));\n}\n\nif (process.env.NODE_ENV === 'development') {\n  global.FetchHelper = module.exports;\n\n  events.on('success', (payload, response) => {\n    Logger.debug('@success', response.url, response.status, payload);\n  });\n\n  events.on('failure', (error, response) => {\n    Logger.debug('@failure', response.url, response.status, error.code, error, error.extra);\n  });\n}\n"],"file":"fetch.helper.js"}